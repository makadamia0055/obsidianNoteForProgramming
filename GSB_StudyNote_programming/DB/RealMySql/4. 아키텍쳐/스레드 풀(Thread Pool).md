# MySQL에서 스레드 풀 ^threadPoolInMySql

- MySQL에서 Default 모델은 [[스레드 모델]]이다. 
- MySQL 서버 엔터프라이즈 에디션은 별도의 스레드 풀 기능을 제공한다.


---
# 스레드 풀의 기능 ^functionOfThreadPool

 ### 스레드 풀의 기본 기능

- 스레드 풀 모델에서는 커넥션과 포그라운드 스레드가 1:1 관계가 아니며, 하나의 스레드가 여러 개의 커넥션 요청을 담당한다.
	- 즉, 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄인다. 
- 사용자 스레드를 줄임으로써 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것을 목적으로 한다. 

 ### 스레드 풀의 성능 향상
 - 스레드 풀은 적절히 사용시 성능향상을 일으킨다.
	 - 제한된 수의 스레드 만으로 CPU가 처리되도록 유도하면 CPU의 프로세서 친화도(Processor affinity)도 높히고, OS 입장에서 불필요한 컨텍스트 스위치(Context Switch) 를 줄여서 오버헤드를 낮출 수 있다. 
 - 그러나 스레드 풀이 실제 서비스에서 눈에 띄게 성능 향상을 보여주는 경우는 드물다.
 - 또 동시에 CPU가 최대한 잘 처리할 수 있는 수준으로 실행중인 스레드 수를 줄여서 빨리 처리하는 기능이기 때문에, 스케줄링 과정에서 CPU 시간을 제대로 확보하지 못하는 경우에는 쿼리 처리가 더 느려질 수도 있다. 

---
# PlugIn 으로 지원하는 스레드 풀 ^threadPoolByPlugIn

 ## Percona Server의 스레드 풀
- Percona Server의 스레드 풀은 플러그인 형태로 작동하게 구현되어 있다. 
- 이를 통해 MySQL 커뮤니티 에디션에서도 스레드 풀 기능을 사용할 수 있다. 
	- 동일 버전의 Percona Server에서 스레드 풀 플러그인 라이브러리(thread_pool.so 파일)를 MySQL 커뮤니티 에디션 서버에 설치(INSTALL PLUGIN 명령)해서 사용 가능.

 ## Percona Server 스레드 풀의 기본 구조
 - Percona Server의 스레드풀은 기본적으로 CPU 코어의 개수만큼 스레드 그룹을 생성
	 - 이는 thread_pool 시스템 변수로 변경 가능. 
	 - 하지만 일반적으로 CPU 코어 개수와 맞추는 것이 CPU 프로세스 친화도를 높이는데 좋다. 
- MySQL 서버에서 처리할 요청이 생기면, 해당 요청 처리를 스레드 풀로 이관하는데, 이때 스레드 풀이 처리 중인 작업이 이미 있는 경우, 설정한 개수만큼 추가로 더 받아들여서 처리할 수 있다.
	- 이 추가 스레드 개수는 thread_pool_oversubscribe 시스템 변수(기본값 : 3)으로 조정한다.
	- 이 값을 너무 크게 설정하면 스레드 풀이 비효율적으로 작동할 수 있다. 

 ## Percona Server 스레드 풀의 처리 루틴
 - 스레드 그룹의 모든 스레드가 일을 처리하고 있으면, 스레드 풀은 해당 스레드 그룹에 새로운 작업 스레드(Worker Thread)를 추가할지, 아니면 기존 작업 스레드가 처리를 완료할 때까지 기다릴지 여부를 판단해야 한다.
 - 스레드 풀의 타이머 스레드는 주기적으로 스레드 그룹의 상태를 체크해서 할당된 시간 동안 처리 중인 작업을 끝내지 않으면 새로운 스레드를 생성해서 스레드 그룹에 추가한다. 
	 - 이 할당 시간은 thread_pool_stall_limit 시스템 변수로 조정한다.(단위 : 밀리초)
	 - 이 때 전체 스레드 풀에 있는 스레드의 개수는 thread_pool_max_threads 시스템 변수에 설정된 개수를 넘어설 수 없다. 
 - 즉, 모든 스레드 그룹의 스레드가 각자 작업을 하는 상태에는, 새로운 쿼리 요청이 들어오더라도, 설정된 할당 시간 동안 기다려야 새로 들어온 요청을 처리할 수 있다.
	 - 따라서 응답 시간에 민감한 서비스라면 할당 시간, 즉 thread_pool_stall_limit 시스템 변수의 값을 적절히 낮추어 설정해야 한다.
	 - 그러나 너무 낮으면 타이머 스레드 동작으로 인한 오버헤드가 커지기 때문에 적절히 설정하는 것이 중요.

 ## Percona Server 스레드 풀의 우선처리 큐 기능
 - Percona Server 스레드 풀은 선순위 큐와 후순위 큐를 제공해, 특정 트랜잭션이나 쿼리를 우선적으로 처리할 수 있는 기능도 제공한다. 
 - 이렇게 먼저 시작된 트랜 잭션 내에 속한 SQL을 빨리 처리해주면, 해당 트랜잭션이 가지고 있는 [[잠금]]이 빨리 해제되고 잠금 경합을 낮춰서 전체적인 처리 성능을 향상시킬 수 있다. 
 
