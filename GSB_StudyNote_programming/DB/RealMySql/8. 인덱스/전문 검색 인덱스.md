---
tags:
---
---
### 전문 검색 인덱스(Full Text search Index)란?
- **문서 전체**에 대한 **분석과 검색**을 위한 **인덱싱 알고리즘**을 **전문 검색 인덱스**(Full Text search Index)라고 하는데, 전문 검색 인덱스는 일반화된 기능의 명칭이지, 전문 검색 알고리즘의 이름을 지칭하는 것은 아니다. 
- 8.5 이전의 인덱스 알고리즘은 일반적으로 크지 않은 데이터 또는 이미 키워드화한 작은 값에 대한 인덱싱 알고리즘이었다. 
	- 대표적으로 MySQL의 B-Tree 인덱스는 실제 칼럼의 값이 1MB이더라도 1MB 전체의 값을 인덱스 키로 사용하는 것이 아니라 1,000바이트(MyISAM) 또는 3072바이트(InnoDB)까지만 잘라서 인덱스 키로 사용한다. 
		- innoDB의 인덱스 키 사이즈는 Innodb_default_row_format 시스템 변수의 값에 따라 변화됨.(책 1권 258p)
	- 또한 B-Tree 인덱스 특성에서도 알아본 것처럼 전체 일치 또는 좌측 일부 일치와 같은 검색만 가능하다. 
- 이러한 구조의 인덱스들은 문서의 내용 전체를 인덱스화해서 특정 키워드가 포함된 문서를 검색하는 전문(Full Text) 검색에는 InnoDB나 MyISAM 스토리지 엔진에서 제공하는 일반적인 용도의 B-Tree 인덱스를 사용할 수 없다. 
- 이하의 내용에서는 InnoDB 중심으로 서술(MySQL 8.0부터 기본 스토리지 엔진이 되었으니.)

---
# 8.5.1 인덱스 알고리즘
- **전문 검색**에서는 **문서 본문의 내용**에서 **사용자가 검색하게 될 키워드**를 **분석**해내고, 빠른 검색용으로 사용할 수 있게 이러한 키워드로 인덱스를 구축한다.
	- 키워드의 분석 및 인덱스 구축에는 여러 가지 방법이 있을 수 있다. 
- 전문 검색 인덱스는 문서의 키워드를 인덱싱하는 기법에 따라 크게 단어의 어근 분석과 n-gram 분석 알고리즘으로 구분할 수 있다. 
	- 예전에는 구분자(공백이나 일부 문장 기호를 기준으로 토큰을 분리)도 하나의 인덱싱 알고리즘처럼 생각됐지만 MySQL 8.0 버전부터는 구분자 방식은 이미 어근 분석과 n-gram 알고리즘에 함께 포함됨.

## 8.5.1.1 어근 분석 알고리즘
- MySQL 서버의 전문 검색 인덱스는 다음과 같은 두 가지 과정을 거쳐 색인 작업을 수행한다. 
	- 불용어(Stop Word)처리
		- 검색에서 별 가치가 없는 단어를 모두 필터링해서 제거하는 작업.
		- 불용어의 개수는 많지 않기 때문에 알고리즘을 구현한 코드에 모두 상수로 정의해서 사용하는 경우가 많음
			- 유연성을 위해 불용어 자체를 데이터베이스화해서 사용자가 추가하거나 삭제할 수 있게 구현하는 경우도 있다.
		- 현재 MySQL 서버는 불용어가 소스코드에 정의돼 있지만, 이를 무시하고 사용자가 별도로 불영어를 정의할 수 있는 기능을 제공한다. 
	- 어근 분석(Stemming)
		- 검색어로 선정된 단어의 뿌리인 원형을 찾는 작업
		- MySQL 서버에서는 오픈소스 형태소 분석 라이브러리인 MeCab를 플러그인 형태로 사용할 수 있게 지원한다. 
			- 한글이나 일본어의 경우 영어와 같이 단어의 변형 자체는 거의 없기 때문에, 어근 분석보다는 문장의 형태소를 분석해서 명사와 조사를 구분하는 기능이 더 중요한 편이다. 
			- 사실 MeCab는 일본어를 위한 형태소 분석 프로그램이며, 서구권 언어를 위한 형태소 분석기는 MongoDB에서 사용되는 Snowball이라는 오픈소스가 있다. 
			- 중요한 것은 각 국가의 언어가 서로 문법이 다르고 다른 방식으로 발전해왔기 때문에 형태소 분석이나 어근 분석 또한 언어별로 방식이 모두 다르다는 것. 
			- 그나마 한국어는 일본어와 많이 비슷하기 때문에 MeCab를 이용해 한글 분석이 가능
		- 하지만 MeCab이 제대로 작동하려면 MeCab 프로그램만 가져다 설치한다고 해결되는 것이 아니다. 
			- 단어사전
			- 문장을 해체해서 각 단어의 품사를 식별할 수 있는 문장의 구조 인식
				- 문장의 구조 인식을 위해서 실제 언어의 샘플을 이용한 언어 학습 과정이 필요
		- 때문에 MeCab를 MySQL 서버에 적용하는 방법은 어렵지 않지만, 한글에 맞게 완성도를 갖추는 작업은 많은 시간과 노력이 필요하다.

>[!note] Stemming를 어간 분석, 어간 추출이라고도 함. (어차피 문법적인 내용이라 중요한 부분은 아닌데 어간에 더 가까운 듯)
>위키 문서 기준으로 어근은 '뜻의 중심', 어간은 '어형 변화의 기초가 되는 부분'이기에 어간이 더 맞다.
>Stemming의 예시[출처](https://cheris8.github.io/data%20analysis/TP-Stemming-Lemmatization/)
> ‘automate’, ‘automatic’, ‘automation’ 이렇게 세개의 단어가 있다고 가정해봅시다. 이들은 각각 ‘e’, ‘ic’, ‘ion’이라는 접사를 가지고 있어 어형이 변형되었지만 모두 ‘automat’라는 어간을 가지고 있습니다. 이러한 단어들에 대하여 접사를 제거하고 동일한 어간인 ‘automat’으로 매핑되도록 하는 작업이 stemming입니다.


## 8.5.1.2 n-gram 알고리즘
- MeCab를 위한 형태소 분석이 매우 전문적이고 고 비용을 요구하여, 범용적 적용을 위한 대안적 알고리즘으로 등장한 것이 n-gram.
- (형태소 분석이 문장을 이해하는 알고리즘이라면,) n-gram은 단순히 키워드를 검색해내기 위한 인덱싱 알고리즘.
- n-gram은 본문을 무조건 몇 글자씩 잘라서 인덱싱하는 방법.
	- 형태소 분석 보다는 알고리즘이 단순하고 국가별 언어에 대한 이해와 준비 작업이 필요 없다.
		- 반면, 만들어진 인덱스의 크기는 상당히 큰 편
	- n-gram의 n은 인덱싱할 키워드의 최소 글자수를 의미하는데, 일반적으로는 2글자 단위로 키워드를 쪼개서 인덱싱하는 2-gram(=Bi-gram) 방식이 많이 사용된다. 
	- 아래 설명도 2글자 키워드 방식의 2-gram 위주로 알아봄.
### MySQL 서버의 n-gram 알고리즘 예시
`To be or not be. That is the question`
- 상기 문장을 2-gram으로 분리하는 예시
	- 각 단어는 다음과 같이 띄어쓰기(공백)와 마침표(.)를 기준으로 10개의 단어로 구분되고, 2글자씩 중첩해서 토큰으로 분리된다. 
		- 여기서 주의할 것은 각 글자가 **중첩해서** 2글자씩 토큰으로 구분됐다는 것이다.
			- 그래서 10글자 단어라면 그 단어는 2-gram 알고리즘에서 (10-1)개의 토큰으로 구분된다. 
		- 이렇게 구분된 각 토큰을 인덱스에 저장하기만 하면 된다.
			- 이때 중복된 토큰은 하나의 인덱스 엔트리로 병합되어 저장된다.
![[MySQL n-gram 토큰 분해 예시 표.png]]
- MySQL 서버는 이렇게 생성된 토큰들에 대해 불용어를 걸러내는 작업을 수행
	- 이때 불용어와 동일하거나 불용어를 포함하는 경우 걸러서 버림.
- 기본적으로 MySQL 서버에 내장된 불용어는 다음과 같은 information_schema.innodb_ft_default_stopword 테이블을 통해 확인 가능
- ![[MySQL 기본 불용어 조회.png]]
	- 해당 불용어와 일치하거나 포함하는 것들을 거르고, 나머지들을 전문 검색 인덱스에 등록함.
- 전문 검색을 더 빠르게 하기 위해 [[2단계 인덱싱|2단계 인덱싱(프런트엔드와 백엔드 인덱스)]]과 같은 방법도 있지만 MySQL 서버는 이렇게 구분된 토큰을 단순한 B-Tree 인덱스에 저장.
	- 물론 성능 향상을 위한 Merge-Tree 같은 기능을 가지고 있긴 하지만 MySQL에서 구현하는 n-gram 알고리즘의 핵심은 이정도로 이해.
## 8.5.1.3 불용어 변경 및 삭제
- 필요에 따라 MySQL의 디폴트 불용어 적용시키지 않거나 사용자 등록 불용어를 추가하는 방법이 있다.(권장)
### 전문 검색 인덱스의 불용어 처리 부시
- 불용어 처리를 무시하는 방법은 두 가지가 있다.
	- 스토리지 엔진에 관계없이 MySQL 서버의 설정 파일(my.cnf)의 ft_stopword_file 시스템 변수에 빈 문자열 설정
		- ft_stopword_file 시스템 변수는 MySQL 서버가 시작될 때만 인지하기 때문에 설정을 변경하면 MySQL 서버를 재시작해야 변경사항 반영됨.
		- `ft_stopword_file=''`
		- ft_stopword_file 시스템 변수는 MySQL 서버의 내장 불용어를 비활성화할 때도 사용할 수 잇지만 사용자 정의 불용어를 적용할 때도 사용할 수 있다.
			- 사용자가 직접 정의한 불용어 목록을 저장한 파일의 경로를 ft_stopword_file 시스템 변수에 할당하면 해당 경로의 파일에서 불용어 목록을 가져와 적용함.
	- InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 인덱스에 대해서만 불용어 처리를 무시할 수도 있다. 
		- InnoDB 테이블의 전문 검색 인덱스의 불용어 처리를 무시하려면 다음과 같이 `innodb_ft_enable_stopword 시스템 변수`를 OFF로 설정하면 된다. 
		- 이 경우 MySQL 서버의 다른 스토리지 엔진(MyISAM 등)을 사용하는 테이블은 여전히 내장 불용어 처리를 사용한다. 
		- `innodb_ft_enable_stopword 시스템 변수`는 동적인 시스템 변수이므로 MySQL 서버가 실행 중인 상태에서도 변경 가능하다. 
		- `mysql> SET GLOBAL innodb_ft_enable_stopword=OFF;`

### 사용자 정의 불용어 사용
- 때로는 MySQL 서버의 내장 불용어를 사용하지 않고, 응용 프로그램의 특성에 맞게 사용자가 직접 정의한 불용어를 사용할 수도 있다. 
- 사용자 불용어를 추가하는 방법은 두 가지이다. 
	- 불용어 목록을 파일로 정리하고, MySQL 서버 설정 파일(my.cnf)에서  ft_stopword_file 시스템 변수에 해당 파일의 경로를 등록하는 방법.
		- `ft_stopword_file-'/data/my_custom_stopword.txt'`
	- 불용어 목록을 테이블로 저장하는 방식
		- InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 엔진에서만 사용할 수 있는 방법
		- 다음과 같이 불용어 테이블을 생성하고, innodb_ft_server_stopword_table 시스템 변수에 불용어 테이블을 설정.
			- 이때 불용어 목록을 변경한 이후 전문 검색 인덱스가 생성돼야만 변경된 불용어가 적용된다는 점에 주의
			- 


# 8.5.2 전문 검색 인덱스의 가용성


