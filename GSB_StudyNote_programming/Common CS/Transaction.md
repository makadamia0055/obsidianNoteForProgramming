---
tags:
  - transcation
aliases:
  - 트랜잭션
  - Transaction
---
---
# 트랜잭션이란?

- 트랜잭션이란 데이터베이스의 상태를 변화 시키는 **하나의 논리적 기능을 수행할 때**, 데이터의 **일관성과 무결성**을 지키기 위해 **규정**된 **작업의 단위, 일련의 연산**을 의미.
	- 데이터베이스 시스템에서 복구 및 병행 시행시 처리되는 작업의 논리적 단위로 '회복의 단위'가 된다. 
	- 하나의 트랜잭션은 commit되거나 rollback된다(/되어야 한다).

## 트랜잭션의 필요성

1. A은행에서 출금하여 B은행으로 송금한다고 가정
2. 송금하던 중 알 수 없는 오류가 발생하여 A은행 계좌에서 돈이 빠져 나갔는데 B은행 계좌에 반영되지 않았다.
3. 이때 , 우리는 A은행 계좌에서 출금을 취소하거나, B계좌로 다시 송금하면 된다.
4. 하지만 이 과정은 번거롭고 더 심한 오류를 발생 시킬 수 있다.
5. 그래서 생각해낸 해결책이, 거래의 단위를 구성하여, 거래가 성공적으로 모두 끝난 후에야 이를 완전한 거래로 승인하고, 거래 도중 뭔가 오류가 발생했을 때는 이 거래를 아예 처음부터 없었던 것처럼 거래를 되돌리는 것이다.

---

# ACID란?
- 데이터 일관성과 무결성을 지키기 위해 트랜잭션에게 요구되는 4가지 특성.
	- 각각의 특성들의 앞 글자를 따서 ACID로 부름. 
## ACID의 종류

 ### Atomicity 원자성
 - 트랜잭션은 하나의 단위로서, 원자적이어야 한다. 
	 - 즉, 작업 수행단위로서, 수행에 있어서는 분할 될 수 없는 성질을 지녀야 한다.
	 - 그러므로 시스템에서 한 트랜잭션의 연산은 **전부 반영되거나 하나도 반영되지 않아야** 한다(**all-or-nothing**)

 ### Consistency 일관성
 - 트랜잭션 처리 전과 처리 후 데이터 모순이 없는 상태, 즉 일관적인 상태를 유지해야 한다.
	 - 여기서 일관성을 지켜야 한다는 것은 도메인 제약, 무결성 제약 등이 트랜잭션 처리 후에도 지켜져야 한다는 뜻이다.
	 - 검색 중 Consistency에 대한 두 가지 설명을 찾게 되었다.
		 - 첫 번째 설명은 도메인 제약, 무결성 제약 준수에 대한 설명이었다.
		 - 두 번째는 '트랜잭션이 진행되는 동안에 데이터베이스가 변경 되더라도 업데이트된 데이터베이스로 트랜잭션이 진행되는 것이 아니라, 처음에 트랜잭션을 진행하기 위해 참조한 데이터베이스로 진행된다.'라는 설명이었다. [참조](https://mommoo.tistory.com/62)
		 - 두 가지 설명 모두 Consistency를 지킨다는 점에서는 설득력이 있으나 (그래서 GPT도 둘 다 맞는 설명으로 봄.), 후자의 설명은 Consistency 보다 Isolation에 더 가깝다고 생각한다. 
		 - 그래서 그냥 전자의 설명으로 생각하면 될 듯 하다.

 ### Isolation 격리성
 - 트랜잭션의 수행에서 다른 트랜잭션의 연산 작업이 끼어들지 못하도록 격리성(독립성, 고립성)이 보장되어야 한다는 것을 의미한다.
 - 수행 중인 트랜잭션의 중간 결과들을 다른 트랜잭션에서 참조가 불가능하다. 
	 - 트랜잭션의 동시 수행은 순차적으로 실행된 경우와 동일한 결과를 보장해야 한다.[참조](https://en.wikipedia.org/wiki/ACID)
	 - 격리성은 [[동시성 제어]]의 주요 목표이다. 


 ### Durability 지속성
 - 트랜잭션이 성공적으로 완료된 후 데이터베이스에 영구적으로 반영되어야 함을 의미한다.
	 - 즉, 커밋된 트랜잭션의 효과는 서비스 중단, 충돌, 기타 실패 사례 등의 오류가 발생하더라도 영구적으로 유지되도록 보장되어야 한다는 것이다. 
	 - [지속성에 대한 참조 문헌](https://en.wikipedia.org/wiki/Durability_(database_systems))

---
### ACID원칙과 [[동시성(Concurrency)]]의 관계
- ACID 원칙을 통한 데이터 일관성과 동시성은 Trade-Off 관계, 즉 상충 관계를 가진다. 
	- 때문에 실제로 ACID원칙은 종종 지켜지지 않는다. 왜냐하면 ACID 원칙을 strict하게 지키려면 동시성이 매우 떨어지기 때문이다. [참조](https://velog.io/@wonizizi99/CS-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-Transaction)
	- 때문에 DBMS에는 일관성과 동시성을 적절히 조율할 수 있도록 격리 수준(Isolation level)을 제공한다. 


---

# MySQL에서의 트랜잭션
- 트랜잭션은 꼭 여러 개의 DML이 조합됐을 때만 의미 있는 개념은 아니다.
	- 쿼리의 숫자와 상관 없이, 하나의 논리적 작업 셋의 원자성을 지키기 위해 도입하는 것이다.
	- 트랜잭션은 `부분 업데이트 현상(Partial Update)`의 발생을 방지한다.
	
 ## Partial Update란?
 - Real MySQL 156p의 예시 : 트랜잭션을 지원하는 InnoDB와 지원하지 않는 MyISAM 테이블을 통한 Partial Update 발생 예시.
	1. 두 테이블을 같은 도메인으로 생성하고, PK키가 3인 레코드를 넣어준다.
	2. 두 테이블에 `INSERT INTO 테이블명 (pk) VALUES (1), (2), (3);` 쿼리를 각각 실행한다.(AUTO-COMMIT 모드 실행)
		- 의도적으로 중복된 PK 값이 발생하게 만든 쿼리.
	3. 실행 결과를 조회하면 MyISAM 테이블에서는 1, 2, 3 / InnoDB 테이블에서는 3이 조회된다.
	4. 두 테이블 모두 1, 2를 정상 입력하고, 3을 입력할 때, 오류가 발생했으나, 트랜잭션을 지원하지 않는 MyISAM 테이블에서는 롤백이 일어나지 않고 InnoDB에서는 트랜잭션의 롤백이 일어났다.
	5. 즉, MyISAM 테이블에서 하나의 쿼리를 통해 1, 2의 값은 입력 되었으나 3은 입력되지 않는 현상이 일어났다. 이것이 부분적으로 값이 업데이트 되는 현상, Partial Update이다.
		- MyISAM과 같이 트랜잭션을 지원하지 않는 테이블에 데이터 정합성을 보장하기 위해서는 쿼리 성공 체크를 위한 분기문과 데이터 클렌징 코드까지 준비하는 등 복잡한 쿼리가 필요하다. 

 ## 트랜잭션 사용시 주의사항
- 트랜잭션은 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.
	- (DBMS의 커넥션처럼) 최소한의 범위에 적용시켜야 한다는 것이다. 
	
 ### 실제 예시를 통해서 살펴보는 트랜잭션 범위 설정
 - Real MySQL 158~160p의 예시
 - 실제 예시 [[일단 생략]]


- 주의사항
	- 굳이 처리 루틴의 시작 지점이라는 이유로, (커넥션과) 트랜잭션을 선언할 이유는 없다. 
		- 커넥션과 트랜잭션을 필요치 않은 코드가 있으면, 해당 코드들을 미리 실행하고 이후 필요한 코드들에만 적용시키는 것이 좋다.
	- 네트워크 작업이 있는 경우에는 반드시 트랜잭션에서 배제해야 한다. 
		- 프로그램이 실행되는 동안 메일 서버와 통신할 수 없는 상황이 발생한다면 웹 서버 뿐만 아니라 DBMS 서버까지 위험해지는 상황이 발생할 것이다. 
		- [[트랜잭션 전파]]
	- 하나의 거대한 단일 트랜잭션을 선언하는 것보다, 각 코드의 기능을  고려하여서, 트랜잭션에서 제외할 코드는 코드는 제외하고, 필수적인 부분만 여러 트랜잭션으로 나누어 선언하는 것이 좋다. 